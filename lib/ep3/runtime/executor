#!/usr/bin/env ruby
require 'optparse'

def insert_cidarg(cmd, cidopt)
  cmd.sub('--rm', cidopt)
end

if $0 == __FILE__
  parser = OptionParser.new
  parser.banner = "Usage: #{$0} [options] <command-file>"
  parser.on('--cidfile=[FILE]')
  opts = parser.getopts(ARGV)

  unless ARGV.length == 1
    puts parser.help
    exit
  end

  command_file = ARGV.first
  unless File.exist?(command_file)
    raise "No such file: #{command_file}"
  end

  cmd = open(command_file).readlines.join
  cmd = insert_cidarg(cmd, opts['cidfile']) if opts.include? 'cidfile'
  system(cmd)
  exit $?.exitstatus
end
